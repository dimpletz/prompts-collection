id: M2-US01
goal: Generate NetSuite OAuth 2.0 Access Token via Client Credentials Flow
version: 1.0
date_created: 2025-08-05
status: 'Planned'
tags: [authentication, netsuite, oauth, core-integration, foundation]
---

# User Story

## Title
Generate NetSuite OAuth 2.0 Access Token via Client Credentials Flow

## Description
As a Magento 2 backend system,
I need to authenticate with NetSuite using the OAuth 2.0 Client Credentials flow,
so that I can securely obtain and cache a valid access token for API communication.

This flow should construct a signed JWT using the ES256 algorithm and securely exchange it with NetSuite’s OAuth endpoint to receive an access_token. The token and expiry must be stored securely and reused until it becomes invalid or expires.

## Acceptance Criteria
| ID    | Acceptance Criteria                        |
|-------|--------------------------------------------|
| AC01  | The system constructs a JWT with claims iss, aud, iat, exp, and scope. |
| AC02  | The JWT is signed using ES256 and a valid EC private key. |
| AC03  | A POST request is sent to NetSuite's OAuth token endpoint with the signed JWT and required parameters. |
| AC04  | On success, an access_token and expires_in are returned and parsed. |
| AC05  | Token and expiry are stored securely in token cache. |
| AC06  | HTTPS is enforced for all token-related communication. |
| AC07  | If an error occurs (e.g., 401 Unauthorized, invalid response), it is logged securely with masked details. |
| AC08  | Unit tests are written for payload generation, signing, request, and response parsing. |
| AC09  | Integration test is available to simulate full token generation using a mock NetSuite endpoint. |
| AC10  | All config values (Client ID, Account ID, Scope, Private Key, Certificate ID) are configurable in Magento Admin (per environment/store). |

## Dependencies
- None (acts as a foundation for all other API-related stories)

## Reference
- NetSuite OAuth 2.0 Client Credentials Flow documentation
- JSON Web Token (JWT) standard (RFC 7519)

## Supporting Information
- PlantUML flowchart: Token generation and handling
- Sequence diagram for US01 (Token Request flow)
- Secure storage should use Magento’s encrypted config (core_config_data) or in-memory token cache.
- Token is required for subsequent stories (US02, US03) to access NetSuite SuiteQL or REST endpoints
